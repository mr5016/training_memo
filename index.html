<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Planner â€“ æ›œæ—¥æŒ‡å®š & ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding-top: 3rem; }
    #statusMsg { min-height: 2rem; }
  </style>
</head>
<body class="bg-light">
<div class="container">
  <h1 class="mb-4">ğŸ‹ï¸â€â™‚ï¸ Workout Planner â€“ æ›œæ—¥æŒ‡å®š & ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h1>

  <!-- API KEY -->
  <div class="card mb-4">
    <div class="card-header">1ï¸âƒ£ OpenAI API ã‚­ãƒ¼</div>
    <div class="card-body">
      <div class="input-group">
        <input id="apiKeyInput" type="text" class="form-control" placeholder="sk-..." />
        <button id="saveKeyBtn" class="btn btn-primary">ã‚­ãƒ¼ä¿å­˜ & ãƒ†ã‚¹ãƒˆ</button>
      </div>
      <div id="statusMsg" class="mt-2"></div>
    </div>
  </div>

  <!-- PREVIOUS LIFT INPUT -->
  <div id="liftCard" class="card mb-4 d-none">
    <div class="card-header">2ï¸âƒ£ å‰å›ã®å®Ÿç¸¾ & æ›œæ—¥ã‚’å…¥åŠ›</div>
    <div class="card-body">
      <!-- Day selection -->
      <div class="mb-4">
        <label class="fw-bold">ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°æ›œæ—¥ã‚’é¸æŠ (è¤‡æ•°å¯)</label>
        <div class="d-flex flex-wrap gap-3" id="daySelect">
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkMon"><label class="form-check-label" for="chkMon">æœˆ</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkTue"><label class="form-check-label" for="chkTue">ç«</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkWed"><label class="form-check-label" for="chkWed">æ°´</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkThu"><label class="form-check-label" for="chkThu">æœ¨</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkFri"><label class="form-check-label" for="chkFri">é‡‘</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkSat"><label class="form-check-label" for="chkSat">åœŸ</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkSun"><label class="form-check-label" for="chkSun">æ—¥</label></div>
        </div>
      </div>

      <div class="row g-4">
        <!-- Function to generate table rows -->
        <script>
          function buildTable(prefix,title){
            document.write(`<div class=\"col-md-4\"><h5 class=\"fw-bold text-center\">${title}</h5><table class=\"table table-sm\"><thead><tr><th>é‡é‡ kg</th><th>å›æ•°</th></tr></thead><tbody>`);
            for(let i=1;i<=5;i++){
              document.write(`<tr><td><input id='${prefix}W${i}' type='number' class='form-control' step='0.5' min='0'></td><td><input id='${prefix}R${i}' type='number' class='form-control' step='1' min='1'></td></tr>`);
            }
            document.write(`</tbody></table></div>`);
          }
          buildTable('bench','ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹');
          buildTable('db','ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹');
          buildTable('fly','ãƒšãƒƒã‚¯ãƒ•ãƒ©ã‚¤');
        </script>
      </div>
      <button id="generateBtn" class="btn btn-success mt-3">ğŸ’¡ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”Ÿæˆ</button>
    </div>
  </div>

  <!-- PLAN OUTPUT -->
  <div id="planArea" class="card d-none">
    <div class="card-header">3ï¸âƒ£ ç”Ÿæˆã•ã‚ŒãŸ 1 é€±é–“ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
    <div class="card-body" id="planDisplay"></div>
  </div>
</div>

<script>
const MODEL='gpt-4o-mini';
const OPENAI_URL='https://api.openai.com/v1/chat/completions';

// ========= Key Handling =========
function sanitizeKey(k){return (k||'').replace(/[\s\u3000]+/g,'').replace(/[^\x00-\x7F]/g,'');}
function saveKey(){const key=sanitizeKey(document.getElementById('apiKeyInput').value);localStorage.setItem('OPENAI_KEY',key);return key;}
function loadKey(){const k=localStorage.getItem('OPENAI_KEY')||'';document.getElementById('apiKeyInput').value=k;return k;}

// ========= UI Helper =========
function setStatus(html,ok=true){const el=document.getElementById('statusMsg');el.className= ok?'text-success':'text-danger';el.innerHTML=html;}
function toggle(elId,show){document.getElementById(elId).classList.toggle('d-none',!show);}

// ========= API Key Test =========
async function testKey(key){
  try{
    const res=await fetch('https://api.openai.com/v1/models',{headers:{'Authorization':'Bearer '+key}});
    if(!res.ok){setStatus(`âŒ æ¥ç¶šå¤±æ•—: ${res.status}`,false);toggle('liftCard',false);return false;}
    const js=await res.json();setStatus('âœ”ï¸ æœ‰åŠ¹ã§ã™');toggle('liftCard',true);return true;
  }catch(e){setStatus('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼:'+e.message,false);toggle('liftCard',false);return false;}
}

// ========= Collect Inputs =========
function collectSets(prefix){const arr=[];for(let i=1;i<=5;i++){const w=document.getElementById(`${prefix}W${i}`).value;const r=document.getElementById(`${prefix}R${i}`).value;if(w&&r) arr.push(`${w}kg x ${r}`);}return arr;}
function collectDays(){const map=[['Mon','æœˆ'],['Tue','ç«'],['Wed','æ°´'],['Thu','æœ¨'],['Fri','é‡‘'],['Sat','åœŸ'],['Sun','æ—¥']];return map.filter(([id])=>document.getElementById('chk'+id).checked).map(a=>a[1]);}

// ========= Prompt Builder =========
function buildPrompt(){
  const bench=collectSets('bench');const db=collectSets('db');const fly=collectSets('fly');
  const days=collectDays();
  const dayLine=days.length?`ã‚ãªãŸãŒãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹æ›œæ—¥ã¯ ${days.join('ã€')} ã§ã™ã€‚ãã‚Œä»¥å¤–ã¯ä¼‘æ¯æ—¥ã¨ã—ã¦ãã ã•ã„ã€‚\n`:'';
  return `ä»¥ä¸‹ã¯å‰å›ã®èƒ¸ãƒˆãƒ¬å®Ÿç¸¾ã§ã™ã€‚\n`+
         `ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹: ${bench.join(', ')||'æœªå…¥åŠ›'}\n`+
         `ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹: ${db.join(', ')||'æœªå…¥åŠ›'}\n`+
         `ãƒšãƒƒã‚¯ãƒ•ãƒ©ã‚¤: ${fly.join(', ')||'æœªå…¥åŠ›'}\n\n`+
         dayLine+
         `åŒã˜3ç¨®ç›®ãƒ»å„5ã‚»ãƒƒãƒˆæ§‹æˆã§1é€±é–“åˆ†ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`+
         `ã‚»ãƒƒãƒˆãŒé€²ã‚€ã”ã¨ã«é‡é‡ã¾ãŸã¯å›æ•°ãŒæ¼¸å¢—ã—ã€RPM(ã¾ãŸã¯RPE)ãŒå°‘ã—ãšã¤ä¸ŠãŒã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚`+
         `JSONå½¢å¼ã§ {\"day1\":{\"ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹\":[\"é‡é‡ x rep\",...],...},...} ã ã‘ã‚’è¿”ç­”ã—ã¦ãã ã•ã„ã€‚`;
}

// ========= Render Plan =========
function renderPlan(obj){
  const area=document.getElementById('planDisplay');area.innerHTML='';
  Object.keys(obj).forEach(day=>{
    const card=document.createElement('div');card.className='card mb-3';
    card.innerHTML=`<div class='card-header fw-bold'>${day}</div>`;
    const list=document.createElement('ul');list.className='list-group list-group-flush';
    const exs=obj[day];
    for(const ex in exs){
      const li=document.createElement('li');li.className='list-group-item';
      li.innerHTML=`<strong>${ex}</strong>: ${exs[ex].join(', ')}`;
      list.appendChild(li);
    }
    card.appendChild(list);area.appendChild(card);
  });
}

// ========= Generate Plan =========
async function generatePlan(){
  toggle('planArea',false);
  const key=sanitizeKey(document.getElementById('apiKeyInput').value);if(!key){alert('APIã‚­ãƒ¼æœªè¨­å®š');return;}
  const body={model:MODEL,max_tokens:800,temperature:0.7,response_format:{type:'json_object'},messages:[{role:'system',content:'You are a certified strength coach. Reply only with JSON.'},{role:'user',content:buildPrompt()}]};
  try{
    const res=await fetch(OPENAI_URL,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify(body)});
    if(!res.ok){alert('ç”Ÿæˆå¤±æ•—: '+res.status);return;}
    const data=await res.json();
    const txt=data.choices?.[0]?.message?.content||'';
    let planObj;try{planObj=JSON.parse(txt);}catch{alert('JSON ãƒ‘ãƒ¼ã‚¹å¤±æ•—');console.error(txt);return;}
    renderPlan(planObj);toggle('planArea',true);
  }catch(e){alert('ã‚¨ãƒ©ãƒ¼:'+e.message);}
}

// ========= Events =========
 document.getElementById('saveKeyBtn').addEventListener('click',async()=>{const key=saveKey();if(!key){setStatus('âŒ ã‚­ãƒ¼ãŒç©º',false);return;}await testKey(key);});
 document.getElementById('generateBtn').addEventListener('click',generatePlan);
 (async()=>{const key=loadKey();if(key) await testKey(key);})();
</script>
</body>
</html>
