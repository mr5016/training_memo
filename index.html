<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Planner – 週別管理 & 1日入力モード (完全版)</title>
  <!-- Bootstrap & Chart.js CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    body{padding-top:3rem}
    #planDisplay .card-header{background:#f5f5f5}
    .exercise-section{border:1px solid #dee2e6;border-radius:.5rem;padding:1rem;margin-bottom:1.5rem}
    .today-row{background:#fff3cd;border-radius:.25rem;padding:.1rem .4rem}
    .editing-row{background:#cff4fc}
  </style>
</head>
<body class="bg-light">
<div class="container">
  <!-- Navigation -->
  <nav class="mb-3">
    <ul class="nav nav-pills">
      <li class="nav-item"><a class="nav-link active" href="#" id="linkPlanner">プラン作成</a></li>
      <li class="nav-item"><a class="nav-link" href="#" id="linkStats">統計</a></li>
    </ul>
  </nav>

  <!-- ================ PAGE : PLANNER ================ -->
  <div id="pagePlanner">
    <h1 class="mb-4">🏋️‍♂️ Workout Planner – 週次保存 & 1日入力</h1>

    <!-- DAY CATEGORY SELECT + WEEK NAVIGATION -->
    <div id="dayCatCard" class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <div>1️⃣ 今週の各曜日カテゴリを選択し、入力する曜日をクリック <small class="text-muted ms-2">(⭐=今日)</small></div>
        <div>
          <button class="btn btn-outline-secondary btn-sm me-2" id="prevWeekBtn">◀ 前の週</button>
          <span id="weekLabel" class="fw-bold"></span>
          <button class="btn btn-outline-secondary btn-sm ms-2" id="nextWeekBtn">次の週 ▶</button>
        </div>
      </div>
      <div class="card-body" id="daySelect"></div>
    </div>

    <!-- INPUT AREA (selected day only) -->
    <div id="liftCard" class="card mb-4 d-none">
      <div class="card-header">2️⃣ <span id="editDayLabel"></span> の実績を入力</div>
      <div class="card-body">
        <!-- Chest -->
        <div class="exercise-section d-none" id="secWrapChest"><h4 class="fw-bold mb-3">胸 (Chest)</h4><div class="row g-4" id="secChest"></div></div>
        <!-- Legs -->
        <div class="exercise-section d-none" id="secWrapLegs"><h4 class="fw-bold mb-3">足 (Legs)</h4><div class="row g-4" id="secLegs"></div></div>
        <!-- Arms -->
        <div class="exercise-section d-none" id="secWrapArms"><h4 class="fw-bold mb-3">腕 (Arms)</h4><div class="row g-4" id="secArms"></div></div>
        <!-- Back -->
        <div class="exercise-section d-none" id="secWrapBack"><h4 class="fw-bold mb-3">背中 (Back)</h4><div class="row g-4" id="secBack"></div></div>
        <button id="saveDayBtn" class="btn btn-primary mt-2">💾 この日の実績を保存</button>
      </div>
    </div>

    <!-- GENERATED PLAN OUTPUT -->
    <div id="planArea" class="card d-none">
      <div class="card-header">3️⃣ 生成された 1 週間メニュー</div>
      <div class="card-body" id="planDisplay"></div>
    </div>
  </div>

  <!-- ================ PAGE : STATS ================ -->
  <div id="pageStats" class="d-none">
    <h2 class="mb-3">📈 進捗グラフ <span id="statsCatLabel" class="badge bg-secondary"></span></h2>
    <div class="card mb-4">
      <div class="card-body"><canvas id="statsChart" height="300"></canvas></div>
      <div class="card-footer d-flex justify-content-between">
        <button class="btn btn-outline-secondary btn-sm" id="prevCatBtn">◀ Previous</button>
        <button class="btn btn-outline-secondary btn-sm" id="nextCatBtn">Next ▶</button>
      </div>
    </div>
    <button class="btn btn-primary" id="backToPlanner">← プランへ戻る</button>
  </div>
</div>

<script>
// ========== CONFIG & CONSTANTS ==========
const DAYS=[{id:'Mon',jp:'月',num:1},{id:'Tue',jp:'火',num:2},{id:'Wed',jp:'水',num:3},{id:'Thu',jp:'木',num:4},{id:'Fri',jp:'金',num:5},{id:'Sat',jp:'土',num:6},{id:'Sun',jp:'日',num:0}];
const CATEGORY_EXERCISES={
  chest:[{prefix:'bench',name:'ベンチプレス'},{prefix:'db',name:'ダンベルプレス'},{prefix:'fly',name:'ペックフライ'}],
  legs:[{prefix:'sq',name:'スクワット'},{prefix:'lc',name:'レッグカール'},{prefix:'le',name:'レッグエクステンション'},{prefix:'lp',name:'レッグプレス'}],
  arms:[{prefix:'ez',name:'EZバーカール'},{prefix:'inc',name:'インクラインカール'},{prefix:'lie',name:'ライイングエクステンション'},{prefix:'pd',name:'プレスダウン'}],
  back:[{prefix:'chin',name:'チンニング'},{prefix:'dl',name:'デッドリフト'},{prefix:'bor',name:'ベントオーバーロー'},{prefix:'dbr',name:'ダンベルロー'}]
};
const STORAGE_KEY_PLAN='wkPlannerWeekV1'; // 週ごとに key が動的に変わる
const STORAGE_KEY_HIST='wkPlannerHistV1';
const CATS=['chest','legs','arms','back'];

// ========== STATE ==========
let planState; // {weekStart, dayCats[7], setsByDay[7]}
let editingDayIdx=null; // 0‑6
let chartInstance=null;
let currentWeekStartStr; // yyyy-mm-dd (月曜)

// ========== HELPERS ==========
const round05=v=>Math.round(v*2)/2;
const estimate1RM=(w,r)=>w*(1+r/30);
// 任意の週(月曜始まり) の yyyy-mm-dd 文字列を返す (offsetWeeks: 0=今週, -1=先週, +1=来週)
function getWeekStart(offsetWeeks=0){
  const today=new Date();
  const day=today.getDay();
  const diff=today.getDate()-day+(day===0?-6:1)+offsetWeeks*7; // 月曜
  const mon=new Date(today.setDate(diff));
  mon.setHours(0,0,0,0);
  return mon.toISOString().slice(0,10);
}

// storage key generator per‑week
const keyForWeek=ws=>`${STORAGE_KEY_PLAN}_${ws}`;

// ========== PLAN STATE LOAD/SAVE (week scoped) ==========
function defaultPlanState(ws){return{weekStart:ws,dayCats:Array(7).fill('off'),setsByDay:Array(7).fill({})};}
function loadPlanState(ws){
  try{
    const ps=JSON.parse(localStorage.getItem(keyForWeek(ws))||'null');
    if(ps && ps.weekStart===ws) return ps;
  }catch{}
  localStorage.removeItem(keyForWeek(ws));
  return defaultPlanState(ws);
}
function savePlanState(){localStorage.setItem(keyForWeek(currentWeekStartStr),JSON.stringify(planState));}

// ========== BUILD EXERCISE TABLES ==========
function buildTable(containerId,prefix,title){
  const container=document.getElementById(containerId);
  const col=document.createElement('div');
  col.className='col-md-4';
  col.innerHTML=`<h5 class='fw-bold text-center'>${title}</h5>
    <table class='table table-sm'>
      <thead><tr><th>重量 kg</th><th>回数</th></tr></thead>
      <tbody>
        ${Array.from({length:5}).map((_,i)=>`<tr>
          <td><input id='${prefix}W${i+1}' type='number' class='form-control' step='0.5' min='0'></td>
          <td><input id='${prefix}R${i+1}' type='number' class='form-control' step='1' min='1'></td>
        </tr>`).join('')}
      </tbody>
    </table>`;
  container.appendChild(col);
}
Object.entries(CATEGORY_EXERCISES).forEach(([cat,arr])=>{
  const containerId={chest:'secChest',legs:'secLegs',arms:'secArms',back:'secBack'}[cat];
  arr.forEach(ex=>buildTable(containerId,ex.prefix,ex.name));
});

// ========== BUILD DAY SELECTOR ==========
function buildDayRows(){
  const wrap=document.getElementById('daySelect');
  wrap.innerHTML='';
  const base=new Date(currentWeekStartStr);
  const todayStr=new Date().toISOString().slice(0,10);
  DAYS.forEach((d,idx)=>{
    const row=document.createElement('div');
    row.className='d-flex align-items-center mb-2 day-row';
    row.dataset.idx=idx;

    // 日付ラベル
    const dateObj=new Date(base);
    dateObj.setDate(dateObj.getDate()+idx);
    const dateStr=`${dateObj.getMonth()+1}/${dateObj.getDate()}`;
    const isToday=dateObj.toISOString().slice(0,10)===todayStr;

    row.innerHTML=`<span class='me-2 ${isToday?'today-row':''}' style='width:5.5rem;'>${d.jp} ${dateStr}${isToday?' ⭐':''}</span>`;

    const sel=document.createElement('select');
    sel.id='sel'+d.id;
    sel.className='form-select form-select-sm';
    sel.style.maxWidth='160px';
    sel.innerHTML=`<option value='off'>オフ</option><option value='chest'>胸</option><option value='legs'>足</option><option value='arms'>腕</option><option value='back'>背中</option>`;
    sel.value=planState.dayCats[idx];
    sel.addEventListener('change',()=>{
      planState.dayCats[idx]=sel.value;
      savePlanState();
      if(editingDayIdx===idx) updateSectionVisibility(sel.value);
    });
    row.appendChild(sel);
    row.addEventListener('click',()=>setEditingDay(idx));
    wrap.appendChild(row);
  });
  // week label
  document.getElementById('weekLabel').innerText=`${currentWeekStartStr} 週`;
}

// ========== SECTION VISIBILITY / INPUT LOAD ==========
function updateSectionVisibility(cat){
  ['Chest','Legs','Arms','Back'].forEach(c=>{
    document.getElementById(`secWrap${c}`).classList.add('d-none');
  });
  if(['chest','legs','arms','back'].includes(cat)){
    document.getElementById(`secWrap${cat.charAt(0).toUpperCase()+cat.slice(1)}`).classList.remove('d-none');
  }
}
function clearInputs(){
  Object.values(CATEGORY_EXERCISES).flat().forEach(ex=>{
    for(let i=1;i<=5;i++){
      document.getElementById(`${ex.prefix}W${i}`).value='';
      document.getElementById(`${ex.prefix}R${i}`).value='';
    }
  });
}
function loadInputsFromState(){
  clearInputs();
  const data=planState.setsByDay[editingDayIdx]||{};
  Object.entries(data).forEach(([prefix,arr])=>{
    arr.forEach((s,i)=>{
      if(i<5){
        document.getElementById(`${prefix}W${i+1}`).value=s.w;
        document.getElementById(`${prefix}R${i+1}`).value=s.r;
      }
    });
  });
}

function setEditingDay(idx){
  editingDayIdx=idx;
  document.querySelectorAll('.day-row').forEach(r=>r.classList.remove('editing-row'));
  document.querySelector(`.day-row[data-idx='${idx}']`).classList.add('editing-row');
  document.getElementById('liftCard').classList.remove('d-none');
  document.getElementById('editDayLabel').innerText=`${DAYS[idx].jp} (${planState.dayCats[idx]==='off'?'オフ':'カテゴリ: '+planState.dayCats[idx]})`;
  updateSectionVisibility(planState.dayCats[idx]);
  loadInputsFromState();
}

// ========== SAVE DAY DATA ==========
function collectSets(prefix){
  const arr=[];
  for(let i=1;i<=5;i++){
    const w=parseFloat(document.getElementById(`${prefix}W${i}`).value);
    const r=parseInt(document.getElementById(`${prefix}R${i}`).value);
    if(!isNaN(w)&&!isNaN(r)) arr.push({w,r});
  }
  return arr;
}
function saveDayData(){
  if(editingDayIdx===null) return;
  const cat=planState.dayCats[editingDayIdx];
  if(cat==='off') return alert('この日はオフに設定されています');
  const dayData={};
  CATEGORY_EXERCISES[cat].forEach(ex=>{
    const s=collectSets(ex.prefix);
    if(s.length) dayData[ex.prefix]=s;
  });
  planState.setsByDay[editingDayIdx]=dayData;
  savePlanState();

  // ======== ★★★ Stats 用に平均 1RM を記録する ★★★
  let sumRM=0,countRM=0;
  for(const exPrefix in dayData){
    dayData[exPrefix].forEach(s=>{
      sumRM+=estimate1RM(s.w,s.r);
      countRM++;
    });
  }
  if(countRM){
    const avgRM=Math.round(sumRM/countRM);
    const dayDate=new Date(planState.weekStart);
    dayDate.setDate(dayDate.getDate()+editingDayIdx);
    const dateStr=dayDate.toISOString().slice(0,10);
    pushHistory(cat,avgRM,dateStr);
  }

  alert('保存しました');
}

// ========== PLAN GENERATION ==========
function renderPlan(plan){
  const area=document.getElementById('planDisplay');
  area.innerHTML='';
  Object.keys(plan).forEach(day=>{
    const card=document.createElement('div');card.className='card mb-3';
    card.innerHTML=`<div class='card-header fw-bold'>${day}</div>`;
    const list=document.createElement('ul');list.className='list-group list-group-flush';
    for(const ex in plan[day]){
      const li=document.createElement('li');li.className='list-group-item';
      li.innerHTML=`<strong>${ex}</strong>: ${plan[day][ex].join(', ')}`;
      list.appendChild(li);
    }
    card.appendChild(list);
    area.appendChild(card);
  });
}
function generatePlan(){
  const progCount={chest:0,legs:0,arms:0,back:0};
  const plan={};
  DAYS.forEach((d,idx)=>{
    const cat=planState.dayCats[idx];
    if(cat==='off') return;
    const dayData=planState.setsByDay[idx]||{};
    if(!Object.keys(dayData).length) return; // no data
    const out={};
    CATEGORY_EXERCISES[cat].forEach(ex=>{
      const sets=dayData[ex.prefix];
      if(!sets) return;
      const modSets=sets.map(s=>{
        const estRM=estimate1RM(s.w,s.r);
        const newRM=estRM+2.5*progCount[cat];
        const newW=round05(newRM/(1+s.r/30));
        return `${newW}kg x ${s.r}`;
      });
      out[ex.name]=modSets;
    });
    plan[`Day ${idx+1} (${d.jp})`]=out;
    progCount[cat]++;
  });
  if(!Object.keys(plan).length) return alert('今週のデータが不足しています');
  renderPlan(plan);
  document.getElementById('planArea').classList.remove('d-none');
}

// ========== HISTORY & STATS ==========
function pushHistory(cat,rm,dateStr){
  const hist=JSON.parse(localStorage.getItem(STORAGE_KEY_HIST)||'{}');
  if(!hist[cat]) hist[cat]=[];
  // 重複チェック (日付が同じなら上書き)
  const existing=hist[cat].find(h=>h.date===dateStr);
  if(existing){existing.rm=rm;}else{hist[cat].push({date:dateStr,rm});}
  hist[cat].sort((a,b)=>new Date(a.date)-new Date(b.date));
  localStorage.setItem(STORAGE_KEY_HIST,JSON.stringify(hist));
}
function showStats(cat){
  const hist=JSON.parse(localStorage.getItem(STORAGE_KEY_HIST)||'{}')[cat]||[];
  const labels=hist.map(h=>h.date);
  const data=hist.map(h=>h.rm);
  document.getElementById('statsCatLabel').innerText={'chest':'胸','legs':'足','arms':'腕','back':'背中'}[cat];
  const ctx=document.getElementById('statsChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'平均1RM',data,fill:false,borderWidth:2}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:false}}}});
}
let currentCatIdx=0;
function switchPage(toStats){
  document.getElementById('pagePlanner').classList.toggle('d-none',toStats);
  document.getElementById('pageStats').classList.toggle('d-none',!toStats);
  document.getElementById('linkPlanner').classList.toggle('active',!toStats);
  document.getElementById('linkStats').classList.toggle('active',toStats);
  if(toStats) showStats(CATS[currentCatIdx]);
}

// ========== WEEK NAVIGATION ==========
let weekOffset=0; // 0=今週
function changeWeek(delta){
  weekOffset+=delta;
  currentWeekStartStr=getWeekStart(weekOffset);
  planState=loadPlanState(currentWeekStartStr);
  buildDayRows();
  // デフォルトで月曜日を選択
  setEditingDay(0);
}

// ========== EVENT LISTENERS ==========
document.getElementById('saveDayBtn').addEventListener('click',saveDayData);
document.getElementById('generateBtn')?.addEventListener('click',generatePlan);
document.getElementById('linkPlanner').addEventListener('click',e=>{e.preventDefault();switchPage(false);});
document.getElementById('linkStats').addEventListener('click',e=>{e.preventDefault();switchPage(true);});
document.getElementById('backToPlanner').addEventListener('click',()=>switchPage(false));
document.getElementById('prevCatBtn').addEventListener('click',()=>{currentCatIdx=(currentCatIdx+3)%4;showStats(CATS[currentCatIdx]);});
document.getElementById('nextCatBtn').addEventListener('click',()=>{currentCatIdx=(currentCatIdx+1)%4;showStats(CATS[currentCatIdx]);});
document.getElementById('prevWeekBtn').addEventListener('click',()=>changeWeek(-1));
document.getElementById('nextWeekBtn').addEventListener('click',()=>changeWeek(1));

// ========== INIT ==========
function init(){
  currentWeekStartStr=getWeekStart(weekOffset);
  planState=loadPlanState(currentWeekStartStr);
  buildDayRows();
  // set today editing if this week, otherwise Monday
  const todayIdx=(new Date().toISOString().slice(0,10).startsWith(currentWeekStartStr))?new Date().getDay():0;
  setEditingDay(todayIdx);
}
init();
</script>
</body>
</html>
