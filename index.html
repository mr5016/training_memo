<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Planner â€“ 5ã‚»ãƒƒãƒˆå¯¾å¿œãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”Ÿæˆãƒ‡ãƒ¢</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding-top: 3rem; }
    #statusMsg { min-height: 2rem; }
    #planArea pre { white-space: pre-wrap; word-break: break-word; }
    table.input-table td { padding: 2px; }
  </style>
</head>
<body class="bg-light">
<div class="container">
  <h1 class="mb-4">ğŸ‹ï¸â€â™‚ï¸ Workout Planner â€“ 5ã‚»ãƒƒãƒˆå¯¾å¿œãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”Ÿæˆ</h1>

  <!-- API KEY -->
  <div class="card mb-4">
    <div class="card-header">1ï¸âƒ£ OpenAI API ã‚­ãƒ¼</div>
    <div class="card-body">
      <div class="input-group">
        <input id="apiKeyInput" type="text" class="form-control" placeholder="sk-..." />
        <button id="saveKeyBtn" class="btn btn-primary">ã‚­ãƒ¼ä¿å­˜ & ãƒ†ã‚¹ãƒˆ</button>
      </div>
      <div id="statusMsg" class="mt-2"></div>
    </div>
  </div>

  <!-- PREVIOUS LIFT INPUT -->
  <div id="liftCard" class="card mb-4 d-none">
    <div class="card-header">2ï¸âƒ£ å‰å›ã®å®Ÿç¸¾ (æœ€å¤§5ã‚»ãƒƒãƒˆ) ã‚’å…¥åŠ›</div>
    <div class="card-body">
      <div class="row g-4">
        <!-- Bench -->
        <div class="col-md-4">
          <h5 class="fw-bold text-center">ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹</h5>
          <table class="table table-sm input-table">
            <thead><tr><th>é‡é‡ kg</th><th>å›æ•°</th></tr></thead>
            <tbody>
              <!-- 5 rows -->
              <script>
                for(let i=1;i<=5;i++){
                  document.write(`<tr><td><input id="benchW${i}" type="number" class="form-control" step="0.5" min="0"></td><td><input id="benchR${i}" type="number" class="form-control" step="1" min="1"></td></tr>`);
                }
              </script>
            </tbody>
          </table>
        </div>
        <!-- Dumbbell Press -->
        <div class="col-md-4">
          <h5 class="fw-bold text-center">ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹</h5>
          <table class="table table-sm input-table">
            <thead><tr><th>é‡é‡ kg</th><th>å›æ•°</th></tr></thead>
            <tbody>
              <script>
                for(let i=1;i<=5;i++){
                  document.write(`<tr><td><input id="dbW${i}" type="number" class="form-control" step="0.5" min="0"></td><td><input id="dbR${i}" type="number" class="form-control" step="1" min="1"></td></tr>`);
                }
              </script>
            </tbody>
          </table>
        </div>
        <!-- Pec Fly -->
        <div class="col-md-4">
          <h5 class="fw-bold text-center">ãƒšãƒƒã‚¯ãƒ•ãƒ©ã‚¤</h5>
          <table class="table table-sm input-table">
            <thead><tr><th>é‡é‡ kg</th><th>å›æ•°</th></tr></thead>
            <tbody>
              <script>
                for(let i=1;i<=5;i++){
                  document.write(`<tr><td><input id="flyW${i}" type="number" class="form-control" step="0.5" min="0"></td><td><input id="flyR${i}" type="number" class="form-control" step="1" min="1"></td></tr>`);
                }
              </script>
            </tbody>
          </table>
        </div>
      </div>
      <button id="generateBtn" class="btn btn-success mt-3">ğŸ’¡ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”Ÿæˆ</button>
    </div>
  </div>

  <!-- PLAN OUTPUT -->
  <div id="planArea" class="card d-none">
    <div class="card-header">3ï¸âƒ£ ç”Ÿæˆã•ã‚ŒãŸ 1 é€±é–“ãƒ¡ãƒ‹ãƒ¥ãƒ¼ (JSON)</div>
    <div class="card-body">
      <pre id="planText"></pre>
    </div>
  </div>

</div>

<script>
const MODEL = 'gpt-4o-mini';
const OPENAI_URL = 'https://api.openai.com/v1/chat/completions';

// ========== Key handling ==========
function sanitizeKey(k){ return (k||'').replace(/[\s\u3000]+/g,'').replace(/[^\x00-\x7F]/g,''); }
function saveKey(){ const key=sanitizeKey(document.getElementById('apiKeyInput').value); localStorage.setItem('OPENAI_KEY',key); return key; }
function loadKey(){ const k=localStorage.getItem('OPENAI_KEY')||''; document.getElementById('apiKeyInput').value=k; return k; }

// ========== UI helpers ==========
function setStatus(html, ok=true){ const el=document.getElementById('statusMsg'); el.className= ok? 'text-success':'text-danger'; el.innerHTML=html; }
function toggleLiftSection(show){ document.getElementById('liftCard').classList.toggle('d-none',!show); }
function togglePlanSection(show){ document.getElementById('planArea').classList.toggle('d-none',!show); }

// ========== OpenAI simple GET /models test ==========
async function testKey(key){
  try{
    const res=await fetch('https://api.openai.com/v1/models',{headers:{'Authorization':'Bearer '+key}});
    if(!res.ok){ setStatus(`âŒ æ¥ç¶šå¤±æ•—ï¼š${res.status} ${res.statusText}`,false); toggleLiftSection(false); return false; }
    const js=await res.json(); const first=js.data?.[0]?.id||'n/a'; setStatus(`âœ”ï¸ æœ‰åŠ¹ã§ã™ï¼ˆä¾‹: ${first}ï¼‰`); toggleLiftSection(true); return true;
  }catch(err){ console.error(err); setStatus('âŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: '+err.message,false); toggleLiftSection(false); return false; }
}

// ========== Helper to collect 5-set data ==========
function collectSets(prefix){
  const arr=[];
  for(let i=1;i<=5;i++){
    const w=document.getElementById(prefix+'W'+i).value;
    const r=document.getElementById(prefix+'R'+i).value;
    if(w && r){ arr.push(`${w}kg x ${r}`); }
  }
  return arr;
}

// ========== Prompt Builder ==========
function buildPrompt(){
  const bench=collectSets('bench');
  const db=collectSets('db');
  const fly=collectSets('fly');
  return `ä»¥ä¸‹ã¯å‰å›ã®èƒ¸ãƒˆãƒ¬å„ç¨®ç›® (æœ€å¤§5ã‚»ãƒƒãƒˆ) ã®å®Ÿç¸¾ã§ã™ã€‚\n`+
         `ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹: ${bench.join(', ') || 'æœªå…¥åŠ›'}\n`+
         `ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹: ${db.join(', ') || 'æœªå…¥åŠ›'}\n`+
         `ãƒšãƒƒã‚¯ãƒ•ãƒ©ã‚¤: ${fly.join(', ') || 'æœªå…¥åŠ›'}\n\n`+
         `ã“ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€ãƒ™ãƒ³ãƒãƒ—ãƒ¬ã‚¹ãƒ»ãƒ€ãƒ³ãƒ™ãƒ«ãƒ—ãƒ¬ã‚¹ãƒ»ãƒšãƒƒã‚¯ãƒ•ãƒ©ã‚¤ã®3ç¨®ç›®ã§1é€±é–“(7æ—¥)ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`+
         `å„ç¨®ç›®ã¨ã‚‚5ã‚»ãƒƒãƒˆæ§‹æˆã¨ã—ã€é‡é‡ã¾ãŸã¯å›æ•°ãŒã‚»ãƒƒãƒˆã‚’è¿½ã†ã”ã¨ã«æ¼¸å¢—ã—ã€RPM (ã¾ãŸã¯RPEç›¸å½“ã®å¼·åº¦æŒ‡æ¨™) ãŒå°‘ã—ãšã¤ä¸ŠãŒã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚`+
         `JSON å½¢å¼ã§ {\"day1\":{\"Bench Press\":[\"é‡é‡ x reps\",...],...}, ... } ã ã‘ã‚’è¿”ç­”ã—ã¦ãã ã•ã„ã€‚ä½™è¨ˆãªèª¬æ˜æ–‡ã‚„ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã¯ä¸è¦ã§ã™ã€‚`;
}

// ========== Menu Generation ==========
async function generatePlan(){
  togglePlanSection(false);
  const key=sanitizeKey(document.getElementById('apiKeyInput').value);
  if(!key){ alert('APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“'); return; }

  const body={
    model: MODEL,
    max_tokens: 700,
    temperature: 0.7,
    response_format:{type:'json_object'},
    messages:[
      {role:'system', content:'You are a certified strength coach. Reply only with JSON.'},
      {role:'user', content: buildPrompt()}
    ]
  };

  try{
    const res=await fetch(OPENAI_URL,{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+key},body:JSON.stringify(body)});
    if(!res.ok){ const txt=await res.text(); alert('ç”Ÿæˆå¤±æ•—:\n'+txt); return; }
    const data=await res.json();
    const content=data.choices?.[0]?.message?.content||'';
    document.getElementById('planText').textContent=content||JSON.stringify(data,null,2);
    togglePlanSection(true);
  }catch(err){ console.error(err); alert('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: '+err.message); }
}

// ========== Event Wiring ==========
document.getElementById('saveKeyBtn').addEventListener('click',async()=>{ const key=saveKey(); if(!key){setStatus('âŒ ã‚­ãƒ¼ãŒç©ºã§ã™',false); return;} await testKey(key);} );
document.getElementById('generateBtn').addEventListener('click',generatePlan);

// On load
a (async()=>{ const key=loadKey(); if(key){ await testKey(key);} })();
</script>
</body>
</html>
