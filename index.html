<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Planner – オフライン版 (数式自動生成)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding-top: 3rem; }
    #planDisplay .card-header { background:#f5f5f5; }
  </style>
</head>
<body class="bg-light">
<div class="container">
  <h1 class="mb-4">🏋️‍♂️ Workout Planner – オフライン版</h1>
  <!-- LIFT & DAY INPUT -->
  <div id="liftCard" class="card mb-4">
    <div class="card-header">1️⃣ 前回の実績 & 曜日を入力</div>
    <div class="card-body">
      <div class="mb-3">
        <label class="fw-bold">トレーニング曜日を選択 (複数可)</label>
        <div class="d-flex flex-wrap gap-3" id="daySelect">
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkMon"><label class="form-check-label" for="chkMon">月</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkTue"><label class="form-check-label" for="chkTue">火</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkWed"><label class="form-check-label" for="chkWed">水</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkThu"><label class="form-check-label" for="chkThu">木</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkFri"><label class="form-check-label" for="chkFri">金</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkSat"><label class="form-check-label" for="chkSat">土</label></div>
          <div class="form-check form-check-inline"><input class="form-check-input" type="checkbox" id="chkSun"><label class="form-check-label" for="chkSun">日</label></div>
        </div>
      </div>
      <div class="row g-4">
        <script>
          function buildTable(prefix,title){
            document.write(`<div class='col-md-4'><h5 class='fw-bold text-center'>${title}</h5><table class='table table-sm'><thead><tr><th>重量 kg</th><th>回数</th></tr></thead><tbody>`);
            for(let i=1;i<=5;i++){
              document.write(`<tr><td><input id='${prefix}W${i}' type='number' class='form-control' step='0.5' min='0'></td><td><input id='${prefix}R${i}' type='number' class='form-control' step='1' min='1'></td></tr>`);
            }
            document.write(`</tbody></table></div>`);
          }
          buildTable('bench','ベンチプレス');
          buildTable('db','ダンベルプレス');
          buildTable('fly','ペックフライ');
        </script>
      </div>
      <button id="generateBtn" class="btn btn-success mt-3">💡 メニュー生成</button>
    </div>
  </div>
  <!-- PLAN OUTPUT -->
  <div id="planArea" class="card d-none">
    <div class="card-header">2️⃣ 生成された 1 週間メニュー</div>
    <div class="card-body" id="planDisplay"></div>
  </div>
</div>
<script>
// === 外部データソース (RPE → %1RM テーブル)
const RPE_CHART_URL = 'https://raw.githubusercontent.com/openai-examples/rpe-chart/main/rpe_chart.json';

// === UI helper ===
const toggle = (id, show) => document.getElementById(id).classList.toggle('d-none', !show);

// === コレクション関数 ===
const collectSets = p => {
  const arr = [];
  for (let i = 1; i <= 5; i++) {
    const w = parseFloat(document.getElementById(p + 'W' + i).value);
    const r = parseInt(document.getElementById(p + 'R' + i).value);
    if (!isNaN(w) && !isNaN(r)) arr.push({ w, r });
  }
  return arr;
};

const collectDays = () =>
  [['Mon', '月'], ['Tue', '火'], ['Wed', '水'], ['Thu', '木'], ['Fri', '金'], ['Sat', '土'], ['Sun', '日']]
    .filter(([id]) => document.getElementById('chk' + id).checked)
    .map(a => a[1]);

// === 数式ユーティリティ ===
const estimate1RM = (w, r) => w * (1 + r / 30); // Epley 公式
const roundToHalf = v => Math.round(v * 2) / 2; // 0.5kg 刻み

// === 外部サイトから RPE テーブル取得 ===
async function fetchRPEChart() {
  try {
    const res = await fetch(RPE_CHART_URL);
    if (!res.ok) throw new Error('fetch error');
    return await res.json();
  } catch (e) {
    // フォールバック (代表値)
    return {
      "3": { "7": 0.88, "7.5": 0.89, "8": 0.91, "8.5": 0.93, "9": 0.95 },
      "4": { "7": 0.85, "7.5": 0.87, "8": 0.88, "8.5": 0.90, "9": 0.92 },
      "5": { "7": 0.82, "7.5": 0.84, "8": 0.86, "8.5": 0.88, "9": 0.90 },
      "6": { "7": 0.79, "7.5": 0.81, "8": 0.83, "8.5": 0.85, "9": 0.87 },
      "8": { "7": 0.72, "7.5": 0.74, "8": 0.76, "8.5": 0.78, "9": 0.80 }
    };
  }
}

// === レンダリング ===
function renderPlan(obj) {
  const area = document.getElementById('planDisplay');
  area.innerHTML = '';
  Object.keys(obj).forEach(day => {
    const card = document.createElement('div');
    card.className = 'card mb-3';
    card.innerHTML = `<div class='card-header fw-bold'>${day}</div>`;
    const list = document.createElement('ul');
    list.className = 'list-group list-group-flush';
    for (const ex in obj[day]) {
      const li = document.createElement('li');
      li.className = 'list-group-item';
      li.innerHTML = `<strong>${ex}</strong>: ${obj[day][ex].join(', ')}`;
      list.appendChild(li);
    }
    card.appendChild(list);
    area.appendChild(card);
  });
}

// === メニュー生成メイン ===
async function generatePlan() {
  toggle('planArea', false);
  const days = collectDays();
  if (!days.length) { alert('曜日を1つ以上選択してください'); return; }

  const exercises = {
    'ベンチプレス': collectSets('bench'),
    'ダンベルプレス': collectSets('db'),
    'ペックフライ': collectSets('fly')
  };

  if (Object.values(exercises).every(arr => arr.length === 0)) {
    alert('最低1種目の実績を入力してください');
    return;
  }

  const rpeChart = await fetchRPEChart();

  const plan = {};
  days.forEach((day, dIdx) => {
    const title = `Day ${dIdx + 1}（${day}）`;
    plan[title] = {};
    Object.entries(exercises).forEach(([name, sets]) => {
      if (!sets.length) return; // 未入力種目はスキップ
      const best = sets.reduce((m, s) => (s.w > m.w ? s : m), sets[0]);
      const est1RM = estimate1RM(best.w, best.r);
      const repScheme = [8, 6, 5, 4, 3];
      const setArr = repScheme.map((rep, i) => {
        const rpe = (7 + i * 0.5).toFixed(1); // 7, 7.5, 8, 8.5, 9
        let pct = rpeChart?.[rep]?.[rpe];
        if (!pct) pct = 0.70 + i * 0.04; // フォールバック
        pct += dIdx * 0.02; // 曜日が後ろほど +2% 重く
        const weight = roundToHalf(est1RM * pct);
        return `${weight}kg x ${rep}`;
      });
      plan[title][name] = setArr;
    });
  });

  renderPlan(plan);
  toggle('planArea', true);
}

// === イベント ===
Document.addEventListener ? document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('generateBtn').addEventListener('click', generatePlan);
}) : window.onload = () => {
  document.getElementById('generateBtn').addEventListener('click', generatePlan);
};
</script>
</body>
</html>
