<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workout Planner – Claude API版</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    .card-log { max-width: 600px; }
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">Workout Planner (Claude API)</h1>

    <!-- API Key -->
    <div class="mb-4">
      <label for="apiKey" class="form-label">Claude API Key</label>
      <input type="password" class="form-control" id="apiKey" placeholder="sk-ant-..." />
      <button class="btn btn-primary mt-2" onclick="saveKey()">保存</button>
    </div>

    <!-- Profile Form -->
    <div class="card p-3 mb-4">
      <h5 class="card-title">プロフィール</h5>
      <div class="row g-2">
        <div class="col-md-2">
          <input type="number" id="age" class="form-control" placeholder="年齢" />
        </div>
        <div class="col-md-3">
          <select id="goal" class="form-select">
            <option value="hypertrophy">筋肥大</option>
            <option value="strength">筋力</option>
            <option value="fat_loss">減量</option>
          </select>
        </div>
        <div class="col-md-3">
          <select id="experience" class="form-select">
            <option value="beginner">初心者</option>
            <option value="intermediate">中級</option>
            <option value="advanced">上級</option>
          </select>
        </div>
        <div class="col-md-4">
          <input type="text" id="equipment" class="form-control" placeholder="所持器具 (comma separated)" />
        </div>
      </div>
      <button class="btn btn-success mt-3" onclick="generatePlan()">初回プラン生成</button>
    </div>

    <!-- Plan Display -->
    <div id="planArea"></div>

    <!-- Progress Graph -->
    <div class="my-5">
      <canvas id="progressChart" height="120"></canvas>
    </div>
  </div>

<script>
const CLAUDE_ENDPOINT = "https://api.anthropic.com/v1/messages";
let apiKey = localStorage.getItem('claude_api_key') || '';
document.getElementById('apiKey').value = apiKey;

function saveKey() {
  apiKey = document.getElementById('apiKey').value.trim();
  localStorage.setItem('claude_api_key', apiKey);
  alert('APIキーを保存しました');
}

function headers() {
  if (!apiKey) {
    alert('まずAPIキーを入力してください');
    throw new Error('API key missing');
  }
  return {
    'Content-Type': 'application/json',
    'X-API-Key': apiKey,
    'anthropic-version': '2023-06-01'
  };
}

function fetchClaude(messages){
  return fetch(CLAUDE_ENDPOINT, {
    method: 'POST',
    headers: headers(),
    body: JSON.stringify({
      model: 'claude-3-sonnet-20240229',
      max_tokens: 1024,
      temperature: 0.7,
      messages
    })
  }).then(r => r.json());
}

function profileData(){
  return {
    age: +document.getElementById('age').value,
    goal: document.getElementById('goal').value,
    experience: document.getElementById('experience').value,
    equipment: document.getElementById('equipment').value.split(',').map(e => e.trim()).filter(Boolean)
  };
}

async function generatePlan(){
  const profile = profileData();
  const prompt = `You are a certified strength coach. Generate a 1‑week workout plan as JSON with keys split_type and days (array of {day, exercises:[{name,sets,reps}]}). All responses must be pure JSON.`;
  const messages=[{role:'user',content:`Profile: ${JSON.stringify(profile)}`},{role:'assistant',content:prompt}];

  try{
    const data = await fetchClaude(messages);
    const text = data.content?.[0]?.text || '';
    const jsonText = text.match(/\{[\s\S]*\}/)?.[0];
    if(!jsonText) throw new Error('JSON not found');
    const plan = JSON.parse(jsonText);
    localStorage.setItem('current_plan', JSON.stringify(plan));
    localStorage.setItem('plan_start', new Date().toISOString());
    renderPlan(plan);
  }catch(err){
    console.error(err);
    alert('プラン生成に失敗しました');
  }
}

function renderPlan(plan){
  const area=document.getElementById('planArea');
  area.innerHTML='';
  if(!plan){area.innerHTML='<p>プランがありません</p>';return;}
  plan.days.forEach((d,idx)=>{
    const card=document.createElement('div');
    card.className='card mb-3 card-log';
    const body=`<div class="card-body"><h5 class="card-title">Day ${idx+1}: ${d.day}</h5>${d.exercises.map(ex=>`<div>${ex.name} — ${ex.sets}×${ex.reps}</div>`).join('')}<button class="btn btn-outline-primary btn-sm mt-2" onclick='addLog("${d.day}")'>ログを追加</button></div>`;
    card.innerHTML=body;
    area.appendChild(card);
  });
}

function addLog(day){
  const exercise=prompt('種目名');
  const weight=prompt('重量(kg)');
  const reps=prompt('レップ数');
  const rpe=prompt('RPE');
  if(!exercise) return;
  const entry={date:new Date().toISOString().slice(0,10),exercise,weight:+weight,reps:+reps,rpe:+rpe};
  const logs=JSON.parse(localStorage.getItem('logs')||'[]');
  logs.push(entry);
  localStorage.setItem('logs',JSON.stringify(logs));
  alert('保存しました');
  updateChart();
}

function updateChart(){
  const ctx=document.getElementById('progressChart');
  const logs=JSON.parse(localStorage.getItem('logs')||'[]');
  const daily={};
  logs.forEach(l=>{daily[l.date]=(daily[l.date]||0)+1;});
  const labels=Object.keys(daily).sort();
  const data=labels.map(k=>daily[k]);
  if(window.myChart){window.myChart.destroy();}
  window.myChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'総セット数',data}]},options:{scales:{y:{beginAtZero:true}}}});
}

function weeklyCheck(){
  const start=localStorage.getItem('plan_start');
  if(!start) return;
  const startDate=new Date(start);
  const now=new Date();
  const diff=(now-startDate)/(1000*60*60*24);
  if(diff>=7){
    // gather last week summary (簡易: ログ件数)
    const logs=JSON.parse(localStorage.getItem('logs')||'[]');
    const lastWeekLogs=logs.filter(l=> (now-new Date(l.date))/(1000*60*60*24) <=7);
    const summary={total_logs:lastWeekLogs.length};
    regeneratePlan(summary);
  }
}

async function regeneratePlan(summary){
  const profile=profileData();
  const prompt=`You are a certified strength coach. Using this summary ${JSON.stringify(summary)}, create a slightly harder workout plan for the next week in the same JSON format.`;
  const messages=[{role:'user',content:`Profile: ${JSON.stringify(profile)} \n Summary: ${JSON.stringify(summary)}`},{role:'assistant',content:prompt}];
  try{
    const data=await fetchClaude(messages);
    const text=data.content?.[0]?.text||'';
    const jsonText=text.match(/\{[\s\S]*\}/)?.[0];
    const plan=JSON.parse(jsonText);
    localStorage.setItem('current_plan',JSON.stringify(plan));
    localStorage.setItem('plan_start',new Date().toISOString());
    localStorage.setItem('logs','[]'); // reset logs
    renderPlan(plan);
  }catch(err){console.error(err);}
}

// Initial load
const storedPlan=JSON.parse(localStorage.getItem('current_plan')||'null');
if(storedPlan) renderPlan(storedPlan);
updateChart();
setInterval(weeklyCheck, 60*60*1000); // 1時間おきに週判定
</script>
</body>
</html>