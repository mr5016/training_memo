<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Workout Planner Web</title>
  <!-- Bootstrap for quick styling -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <!-- Chart.js for progress graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body { background: #f8f9fa; }
    #plan-area pre { white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h1 class="mb-4">🏋️‍♀️ Workout Planner</h1>

    <!-- 1. OpenAI API KEY -->
    <div class="card mb-4">
      <div class="card-header">OpenAI API キー設定</div>
      <div class="card-body">
        <div class="row g-2 align-items-center">
          <div class="col-md-9">
            <input
              type="password"
              id="apiKeyInput"
              class="form-control"
              placeholder="sk-..."
            />
          </div>
          <div class="col-md-3 d-grid">
            <button id="saveKeyBtn" class="btn btn-primary">
              保存 / 更新
            </button>
          </div>
        </div>
        <small class="text-muted"
          >キーはブラウザの <code>localStorage</code> にのみ保存され、サーバには送信されません。</small
        >
      </div>
    </div>

    <!-- 2. Profile & Plan Generation -->
    <div class="card mb-4">
      <div class="card-header">プロフィール & 初回プラン生成</div>
      <div class="card-body">
        <div class="row g-3 mb-3">
          <div class="col-md-3">
            <label class="form-label">年齢</label>
            <input type="number" id="age" class="form-control" value="25" />
          </div>
          <div class="col-md-3">
            <label class="form-label">目標</label>
            <select id="goal" class="form-select">
              <option value="hypertrophy" selected>筋肥大</option>
              <option value="strength">筋力向上</option>
              <option value="fat_loss">減量</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">経験</label>
            <select id="experience" class="form-select">
              <option value="beginner">初心者</option>
              <option value="intermediate" selected>中級者</option>
              <option value="advanced">上級者</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">器具 (カンマ区切り)</label>
            <input
              type="text"
              id="equipment"
              class="form-control"
              value="barbell,dumbbell,bench"
            />
          </div>
        </div>
        <div class="d-grid">
          <button id="generatePlanBtn" class="btn btn-success">
            🎲 初回プラン生成
          </button>
        </div>
      </div>
    </div>

    <!-- 3. Plan Display -->
    <div class="card mb-4" id="planCard" style="display:none;">
      <div class="card-header">今週のプラン</div>
      <div class="card-body" id="plan-area">
        <!-- plan JSON pretty -->
      </div>
    </div>

    <!-- 4. Log Workout -->
    <div class="card mb-4" id="logCard" style="display:none;">
      <div class="card-header">ワークアウト記録</div>
      <div class="card-body">
        <div class="row g-2 align-items-end">
          <div class="col-md-3">
            <label class="form-label">種目</label>
            <select id="exerciseSelect" class="form-select"></select>
          </div>
          <div class="col-md-2">
            <label class="form-label">重量 (kg)</label>
            <input type="number" id="weight" class="form-control" />
          </div>
          <div class="col-md-2">
            <label class="form-label">レップ</label>
            <input type="number" id="reps" class="form-control" />
          </div>
          <div class="col-md-2">
            <label class="form-label">RPE</label>
            <input type="number" id="rpe" step="0.5" class="form-control" />
          </div>
          <div class="col-md-3 d-grid">
            <button id="addLogBtn" class="btn btn-outline-primary">追加</button>
          </div>
        </div>
        <hr />
        <table class="table table-sm" id="logTable">
          <thead>
            <tr>
              <th>日付</th>
              <th>種目</th>
              <th>重量</th>
              <th>reps</th>
              <th>RPE</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- 5. Progress Graph -->
    <div class="card mb-4" id="graphCard" style="display:none;">
      <div class="card-header">過去 4 週間の総セット数</div>
      <div class="card-body">
        <canvas id="progressChart" height="120"></canvas>
      </div>
    </div>
  </div>

  <script>
    // Storage Keys
    const LS_KEY_API = "openai_api_key";
    const LS_KEY_PLAN = "current_plan";
    const LS_KEY_LOGS = "workout_logs";

    // Elements
    const apiKeyInput = document.getElementById("apiKeyInput");
    const saveKeyBtn = document.getElementById("saveKeyBtn");
    const generatePlanBtn = document.getElementById("generatePlanBtn");
    const planCard = document.getElementById("planCard");
    const planArea = document.getElementById("plan-area");
    const logCard = document.getElementById("logCard");
    const graphCard = document.getElementById("graphCard");
    const exerciseSelect = document.getElementById("exerciseSelect");
    const addLogBtn = document.getElementById("addLogBtn");
    const logTableBody = document.querySelector("#logTable tbody");
    const ctxChart = document.getElementById("progressChart").getContext("2d");
    let chartInstance;

    // Initialize UI from localStorage
    window.addEventListener("DOMContentLoaded", () => {
      const storedKey = localStorage.getItem(LS_KEY_API);
      if (storedKey) apiKeyInput.value = storedKey;
      const storedPlan = JSON.parse(localStorage.getItem(LS_KEY_PLAN) || "null");
      if (storedPlan) renderPlan(storedPlan);
      const storedLogs = JSON.parse(localStorage.getItem(LS_KEY_LOGS) || "[]");
      storedLogs.forEach(addLogRow);
      updateGraph();
    });

    saveKeyBtn.addEventListener("click", () => {
      localStorage.setItem(LS_KEY_API, apiKeyInput.value.trim());
      alert("API キーを保存しました");
    });

    generatePlanBtn.addEventListener("click", async () => {
      const apiKey = apiKeyInput.value.trim();
      if (!apiKey) return alert("API キーを入力してください");

      const profile = {
        age: Number(document.getElementById("age").value),
        goal: document.getElementById("goal").value,
        experience: document.getElementById("experience").value,
        equipment: document.getElementById("equipment").value.split(/[,、]/).map(s => s.trim()).filter(Boolean)
      };

      generatePlanBtn.disabled = true;
      generatePlanBtn.textContent = "生成中...";
      try {
        const plan = await callOpenAI(apiKey, profile);
        localStorage.setItem(LS_KEY_PLAN, JSON.stringify(plan));
        renderPlan(plan);
        alert("プランを生成しました！");
      } catch (err) {
        console.error(err);
        alert("プラン生成に失敗しました: " + err.message);
      } finally {
        generatePlanBtn.disabled = false;
        generatePlanBtn.textContent = "🎲 初回プラン生成";
      }
    });

    addLogBtn.addEventListener("click", () => {
      const logs = JSON.parse(localStorage.getItem(LS_KEY_LOGS) || "[]");
      const entry = {
        date: new Date().toISOString().slice(0, 10),
        exercise: exerciseSelect.value,
        weight: Number(document.getElementById("weight").value),
        reps: Number(document.getElementById("reps").value),
        rpe: Number(document.getElementById("rpe").value)
      };
      logs.push(entry);
      localStorage.setItem(LS_KEY_LOGS, JSON.stringify(logs));
      addLogRow(entry);
      updateGraph();
      // reset inputs
      document.getElementById("weight").value = "";
      document.getElementById("reps").value = "";
      document.getElementById("rpe").value = "";
    });

    function addLogRow(e) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${e.date}</td><td>${e.exercise}</td><td>${e.weight}</td><td>${e.reps}</td><td>${e.rpe}</td>`;
      logTableBody.appendChild(tr);
      logCard.style.display = "block";
    }

    async function callOpenAI(apiKey, profile) {
      const system = "You are a certified strength coach. Return a 1-week workout plan as JSON.";
      const user = `Create a 1-week hypertrophy plan for the following profile in JSON format only. Profile: ${JSON.stringify(profile)}`;

      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: system },
            { role: "user", content: user }
          ],
          response_format: { type: "json_object" }
        })
      });
      if (!res.ok) throw new Error(await res.text());
      const data = await res.json();
      return JSON.parse(data.choices[0].message.content);
    }

    function renderPlan(plan) {
      planArea.innerHTML = `<pre>${JSON.stringify(plan, null, 2)}</pre>`;
      planCard.style.display = "block";
      // Populate exercise dropdown
      const exercises = plan.days.flatMap(d => d.exercises.map(ex => ex.name));
      exerciseSelect.innerHTML = exercises.map(ex => `<option value="${ex}">${ex}</option>`).join("");
      logCard.style.display = "block";
      graphCard.style.display = "block";
    }

    function updateGraph() {
      const logs = JSON.parse(localStorage.getItem(LS_KEY_LOGS) || "[]");
      const dailySets = {};
      logs.forEach(l => {
        dailySets[l.date] = (dailySets[l.date] || 0) + 1;
      });
      const labels = Object.keys(dailySets).sort();
      const data = labels.map(d => dailySets[d]);

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctxChart, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Sets per Day",
              data,
              tension: 0.3,
              fill: false,
              borderWidth: 2
            }
          ]
        },
        options: {
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: { beginAtZero: true, stepSize: 1 }
          }
        }
      });
    }
  </script>
</body>
</html>
