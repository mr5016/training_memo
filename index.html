<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenAI API キー動作テスト & 会話デモ</title>
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding-top: 4rem; }
    #statusMsg { min-height: 2rem; }
    #chatLog { height: 280px; overflow-y: auto; border: 1px solid #ced4da; border-radius: .375rem; padding: .5rem; background:#f8f9fa; }
    .msg-user { text-align: right; }
    .msg-assist { text-align: left; color:#0d6efd; }
    .msg { margin-bottom: .25rem; white-space: pre-wrap; word-break: break-word; }
  </style>
</head>
<body class="container">
  <h1 class="h3 mb-4">OpenAI API キーテスト & 動作確認チャット</h1>

  <!-- API KEY INPUT -->
  <div class="mb-3 row">
    <label class="col-sm-2 col-form-label">OpenAI&nbsp;APIキー</label>
    <div class="col-sm-6">
      <input type="text" id="apiKeyInput" class="form-control" placeholder="sk-..." />
    </div>
    <div class="col-sm-2">
      <button id="saveKeyBtn" class="btn btn-primary w-100">保存</button>
    </div>
  </div>
  <div id="statusMsg" class="mb-4"></div>

  <!-- CHAT AREA -->
  <div id="chatArea" style="display:none;">
    <h2 class="h5 mb-2">簡易チャット</h2>
    <div id="chatLog" class="mb-3"></div>
    <div class="input-group">
      <textarea id="userInput" class="form-control" rows="2" placeholder="メッセージを入力..."></textarea>
      <button id="sendBtn" class="btn btn-success">送信</button>
    </div>
  </div>

<script>
const ENDPOINT = 'https://api.openai.com/v1/chat/completions';
const MODEL = 'gpt-4o-mini';
let apiKey = localStorage.getItem('OPENAI_KEY_TEST') || '';
let messages = [{ role:'system', content:'You are a helpful assistant.' }];

// DOM refs
const keyInput = document.getElementById('apiKeyInput');
const saveKeyBtn = document.getElementById('saveKeyBtn');
const statusMsg = document.getElementById('statusMsg');
const chatArea  = document.getElementById('chatArea');
const chatLog   = document.getElementById('chatLog');
const userInput = document.getElementById('userInput');
const sendBtn   = document.getElementById('sendBtn');

keyInput.value = apiKey;
if(apiKey) { validateKey(); }

saveKeyBtn.addEventListener('click', () => {
  apiKey = keyInput.value.trim();
  if(!apiKey) { showStatus('APIキーを入力してください', false); return; }
  localStorage.setItem('OPENAI_KEY_TEST', apiKey);
  validateKey();
});

async function validateKey(){
  showStatus('キーを検証中...', true);
  try{
    const res = await fetch('https://api.openai.com/v1/models', {
      method:'GET',
      headers:{ 'Authorization':'Bearer '+apiKey }
    });
    if(!res.ok){ throw new Error(`HTTP ${res.status}`); }
    const data = await res.json();
    const modelSample = data?.data?.[0]?.id || 'unknown';
    showStatus(`✔️ 有効です（例: ${modelSample}）`, true);
    chatArea.style.display = '';
  }catch(err){
    showStatus('❌ キー検証失敗: '+err.message, false);
    chatArea.style.display = 'none';
  }
}

function showStatus(msg, success){
  statusMsg.textContent = msg;
  statusMsg.className = success ? 'text-success' : 'text-danger';
}

function appendMsg(role, text){
  const div = document.createElement('div');
  div.className = 'msg '+(role==='user'?'msg-user':'msg-assist');
  div.textContent = text;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;
}

sendBtn.addEventListener('click', async ()=>{
  const content = userInput.value.trim();
  if(!content){ return; }
  userInput.value='';
  appendMsg('user', content);
  messages.push({ role:'user', content });
  sendBtn.disabled = true;
  try{
    const body = { model: MODEL, max_tokens:256, temperature:0.7, messages};
    const res = await fetch(ENDPOINT, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':'Bearer '+apiKey
      },
      body: JSON.stringify(body)
    });
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    const data = await res.json();
    const assistantMsg = data.choices[0].message.content.trim();
    messages.push({ role:'assistant', content: assistantMsg });
    appendMsg('assistant', assistantMsg);
  }catch(err){
    appendMsg('assistant', '❌ エラー: '+err.message);
  }finally{
    sendBtn.disabled = false;
  }
});
</script>
</body>
</html>
