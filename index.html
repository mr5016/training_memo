<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenAI API キー動作テスト</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding-top: 4rem; }
    #result pre { white-space: pre-wrap; word-break: break-all; }
  </style>
</head>
<body class="bg-light">
  <div class="container">
    <h1 class="mb-4">OpenAI API キー接続テスト</h1>
    <div class="mb-3">
      <label for="apiKey" class="form-label">OpenAI API キー</label>
      <input type="password" class="form-control" id="apiKey" placeholder="sk-..." />
    </div>
    <button id="testBtn" class="btn btn-primary">接続テストを実行</button>

    <hr class="my-4" />
    <div id="result" class="alert d-none" role="alert"></div>
  </div>

  <script>
    const endpoint = "https://api.openai.com/v1/models"; // GET なら最小コスト＆CORS 対応

    document.getElementById("testBtn").addEventListener("click", async () => {
      const keyRaw = document.getElementById("apiKey").value;
      const apiKey = sanitizeKey(keyRaw);
      if (!apiKey) {
        show("danger", "API キーを入力してください。<br>ダッシュボードでコピーした文字列をそのまま貼り付け。");
        return;
      }

      show("info", "テストリクエスト送信中 …");

      try {
        const res = await fetch(endpoint, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${apiKey}`,
            "Content-Type": "application/json"
          }
        });

        if (!res.ok) {
          const txt = await res.text();
          show("danger", `失敗 (HTTP ${res.status})<br><pre>${escapeHtml(txt)}</pre>`);
          return;
        }

        const data = await res.json();
        const first = (data.data || []).slice(0, 5).map(m => m.id).join("<br>");
        show("success", `✅ 接続成功！取得モデル例:<br><pre>${first}</pre>`);
      } catch (err) {
        show("danger", `fetch 失敗:<br><pre>${escapeHtml(err.message)}</pre>`);
      }
    });

    function show(type, html) {
      const box = document.getElementById("result");
      box.className = `alert alert-${type}`;
      box.innerHTML = html;
      box.classList.remove("d-none");
    }

    function sanitizeKey(k) {
      return (k || "").trim().replace(/[\s\u3000]+/g, "");
    }

    function escapeHtml(str) {
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/\"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
  </script>
</body>
</html>
