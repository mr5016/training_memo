<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workout Planner – オフライン版 (保存機能付き)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { padding-top: 3rem; }
    #planDisplay .card-header { background:#f5f5f5; }
    .exercise-section { border:1px solid #dee2e6; border-radius:.5rem; padding:1rem; margin-bottom:1.5rem; }
  </style>
</head>
<body class="bg-light">
<div class="container">
  <h1 class="mb-4">🏋️‍♂️ Workout Planner – カテゴリ別進行 + 保存</h1>

  <!-- DAY CATEGORY SELECT -->
  <div id="dayCatCard" class="card mb-4">
    <div class="card-header">1️⃣ 各曜日のカテゴリを選択</div>
    <div class="card-body" id="daySelect"></div>
  </div>

  <!-- PREVIOUS SETS INPUT -->
  <div id="liftCard" class="card mb-4">
    <div class="card-header">2️⃣ 前回の実績を入力</div>
    <div class="card-body">

      <!-- Chest -->
      <div class="exercise-section">
        <h4 class="fw-bold mb-3">胸 (Chest)</h4>
        <div class="row g-4" id="secChest"></div>
      </div>

      <!-- Legs -->
      <div class="exercise-section">
        <h4 class="fw-bold mb-3">足 (Legs)</h4>
        <div class="row g-4" id="secLegs"></div>
      </div>

      <!-- Arms -->
      <div class="exercise-section">
        <h4 class="fw-bold mb-3">腕 (Arms)</h4>
        <div class="row g-4" id="secArms"></div>
      </div>

      <!-- Back -->
      <div class="exercise-section">
        <h4 class="fw-bold mb-3">背中 (Back)</h4>
        <div class="row g-4" id="secBack"></div>
      </div>

      <button id="generateBtn" class="btn btn-success mt-2">💡 メニュー生成 & 保存</button>
      <span id="saveStatus" class="ms-3 text-success d-none">✔️ 保存しました</span>
    </div>
  </div>

  <!-- PLAN OUTPUT -->
  <div id="planArea" class="card d-none">
    <div class="card-header">3️⃣ 生成された 1 週間メニュー</div>
    <div class="card-body" id="planDisplay"></div>
  </div>
</div>

<script>
// ==== Configuration ====
const DAYS = [
  {id:'Mon', jp:'月'},
  {id:'Tue', jp:'火'},
  {id:'Wed', jp:'水'},
  {id:'Thu', jp:'木'},
  {id:'Fri', jp:'金'},
  {id:'Sat', jp:'土'},
  {id:'Sun', jp:'日'}
];

const CATEGORY_EXERCISES = {
  chest: [
    {prefix:'bench', name:'ベンチプレス'},
    {prefix:'db',    name:'ダンベルプレス'},
    {prefix:'fly',   name:'ペックフライ'}
  ],
  legs: [
    {prefix:'sq',  name:'スクワット'},
    {prefix:'lc',  name:'レッグカール'},
    {prefix:'le',  name:'レッグエクステンション'},
    {prefix:'lp',  name:'レッグプレス'}
  ],
  arms: [
    {prefix:'ez',  name:'EZバーカール'},
    {prefix:'inc', name:'インクラインカール'},
    {prefix:'lie', name:'ライイングエクステンション'},
    {prefix:'pd',  name:'プレスダウン'}
  ],
  back: [
    {prefix:'chin', name:'チンニング'},
    {prefix:'dl',   name:'デッドリフト'},
    {prefix:'bor',  name:'ベントオーバーロー'},
    {prefix:'dbr',  name:'ダンベルロー'}
  ]
};

const STORAGE_KEY = 'wkPlannerDataV1';

// ==== Build UI ====
function buildTable(containerId, prefix, title) {
  const container = document.getElementById(containerId);
  const col = document.createElement('div');
  col.className = 'col-md-4';
  col.innerHTML = `<h5 class='fw-bold text-center'>${title}</h5>
    <table class='table table-sm'>
      <thead><tr><th>重量 kg</th><th>回数</th></tr></thead>
      <tbody>
        ${Array.from({length:5}).map((_,i)=>
          `<tr><td><input id='${prefix}W${i+1}' type='number' class='form-control' step='0.5' min='0'></td>
               <td><input id='${prefix}R${i+1}' type='number' class='form-control' step='1' min='1'></td></tr>`).join('')}
      </tbody>
    </table>`;
  container.appendChild(col);
}

// Build day selectors
(function buildDaySelectors(){
  const daySelect = document.getElementById('daySelect');
  DAYS.forEach(d=>{
    const row = document.createElement('div');
    row.className = 'd-flex align-items-center mb-2';
    row.innerHTML = `<span class='me-2' style='width:2rem;'>${d.jp}</span>
      <select id='sel${d.id}' class='form-select form-select-sm' style='max-width:160px;'>
        <option value='off'>オフ</option>
        <option value='chest'>胸</option>
        <option value='legs'>足</option>
        <option value='arms'>腕</option>
        <option value='back'>背中</option>
      </select>`;
    daySelect.appendChild(row);
  });
})();

// Build exercise input tables
(function buildAllTables(){
  Object.entries(CATEGORY_EXERCISES).forEach(([cat, arr])=>{
    const containerId = { chest:'secChest', legs:'secLegs', arms:'secArms', back:'secBack' }[cat];
    arr.forEach(ex=> buildTable(containerId, ex.prefix, ex.name));
  });
})();

// ==== Utilities ====
const round05 = v => Math.round(v * 2) / 2; // 0.5kg 刻み
const estimate1RM = (w, r) => w * (1 + r / 30); // Epley 公式

function collectSets(prefix){
  const arr = [];
  for(let i=1;i<=5;i++){
    const w = parseFloat(document.getElementById(prefix+'W'+i).value);
    const r = parseInt(document.getElementById(prefix+'R'+i).value);
    if(!isNaN(w) && !isNaN(r)) arr.push({w,r});
  }
  return arr;
}

function collectTemplates(){
  const templates = {};
  Object.entries(CATEGORY_EXERCISES).forEach(([cat,exArr])=>{
    exArr.forEach(ex=>{
      const s = collectSets(ex.prefix);
      if(s.length){
        if(!templates[cat]) templates[cat] = {};
        templates[cat][ex.name] = s; // store with Japanese name
      }
    });
  });
  return templates;
}

function collectDayCategories(){
  return DAYS.map(d=> document.getElementById('sel'+d.id).value);
}

// ==== Local Storage Handling ====
function saveData(){
  const data = { dayCats: collectDayCategories(), sets:{} };
  // Save sets
  Object.values(CATEGORY_EXERCISES).flat().forEach(ex=>{
    const s = collectSets(ex.prefix);
    if(s.length) data.sets[ex.prefix] = s;
  });
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  document.getElementById('saveStatus').classList.remove('d-none');
  setTimeout(()=>document.getElementById('saveStatus').classList.add('d-none'),2000);
}

function loadData(){
  const str = localStorage.getItem(STORAGE_KEY);
  if(!str) return;
  try{
    const data = JSON.parse(str);
    // Restore day categories
    if(Array.isArray(data.dayCats)){
      data.dayCats.forEach((cat, idx)=>{
        const sel = document.getElementById('sel'+DAYS[idx].id);
        if(sel) sel.value = cat || 'off';
      });
    }
    // Restore sets
    if(data.sets && typeof data.sets==='object'){
      Object.entries(data.sets).forEach(([prefix, arr])=>{
        arr.forEach((o,i)=>{
          if(i>=5) return;
          const wInput = document.getElementById(prefix+'W'+(i+1));
          const rInput = document.getElementById(prefix+'R'+(i+1));
          if(wInput && rInput){
            wInput.value = o.w;
            rInput.value = o.r;
          }
        });
      });
    }
  }catch(e){ console.warn('Load failed',e); }
}

// ==== Generator ====
function generatePlan(){
  const templates = collectTemplates();
  const dayCats = collectDayCategories();
  const progCount = {chest:0, legs:0, arms:0, back:0};
  const plan = {};

  dayCats.forEach((cat, idx)=>{
    const dayLabel = `${DAYS[idx].jp}`;
    if(cat==='off') return; // rest day
    if(!templates[cat]) return; // no template data

    const exercises = templates[cat];
    const out = {};
    Object.entries(exercises).forEach(([exName, sets])=>{
      const modSets = sets.map(s=>{
        const estRM = estimate1RM(s.w,s.r);
        const newRM = estRM + 2.5 * progCount[cat];
        const newW = round05(newRM / (1 + s.r/30));
        return `${newW}kg x ${s.r}`;
      });
      out[exName] = modSets;
    });
    plan[`Day ${idx+1} (${dayLabel})`] = out;
    progCount[cat]++;
  });

  if(Object.keys(plan).length===0){
    alert('入力不足です。カテゴリと実績を確認してください');
    return;
  }

  renderPlan(plan);
  document.getElementById('planArea').classList.remove('d-none');
  saveData(); // 保存
}

// ==== Renderer ====
function renderPlan(obj){
  const area = document.getElementById('planDisplay');
  area.innerHTML='';
  Object.keys(obj).forEach(day=>{
    const card=document.createElement('div');
    card.className='card mb-3';
    card.innerHTML=`<div class='card-header fw-bold'>${day}</div>`;
    const list=document.createElement('ul');
    list.className='list-group list-group-flush';
    for(const ex in obj[day]){
      const li=document.createElement('li');
      li.className='list-group-item';
      li.innerHTML=`<strong>${ex}</strong>: ${obj[day][ex].join(', ')}`;
      list.appendChild(li);
    }
    card.appendChild(list);
    area.appendChild(card);
  });
}

// ==== Events ====
document.getElementById('generateBtn').addEventListener('click', generatePlan);

// ==== Init ====
loadData(); // ページ読み込み時に過去データを復元
</script>
</body>
</html>
